<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Prebid + GPT Blogger Gadget (fixed)</title>
  <style>
    /* Simple styles - adjust to your theme as needed */
    .ad-slot { margin: 12px 0; text-align: center; }
    #div-gpt-ad-123456789-0 { width: 100%; min-height: 90px; margin: 0 auto; }
  </style>
</head>
<body>
  <div class="ad-slot">
    <div id="div-gpt-ad-123456789-0"> <!-- GPT will inject the creative here --> </div>
  </div>

  <!-- Load GPT (required for Google Publisher Tags) -->
  <script async src="https://securepubads.g.doubleclick.net/tag/js/gpt.js" crossorigin="anonymous"></script>

  <!-- Optional: Prebid testing CDN (defensive load; may be blocked in some environments) -->
  <script>
    (function() {
      var s = document.createElement('script');
      s.src = 'https://acdn.adnxs.com/prebid/not-for-prod/prebid.js';
      s.async = true;
      s.onload = function(){ console.info('Prebid test script loaded'); };
      s.onerror = function(){ console.info('Prebid test script failed to load (this is expected on some hosts)'); };
      document.head.appendChild(s);
    })();
  </script>

  <!-- Inline safe Prebid config (no bidders) -->
  <script>
    (function(window){
      var PREBID_TIMEOUT = 1200;
      var pbjs = window.pbjs = window.pbjs || {};
      pbjs.que = pbjs.que || [];
      pbjs.logging = false;

      var adUnits = [
        {
          code: 'div-gpt-ad-123456789-0',
          mediaTypes: { banner: { sizes: [[970,250],[728,90],[320,50]] } },
          bids: [] // SAFE: no bidders in test mode to avoid adapter/network errors
        }
      ];

      function requestPrebidSafe(callback) {
        // If pbjs.requestBids isn't available yet, call callback immediately
        if (!window.pbjs || typeof pbjs.requestBids !== 'function') {
          console.info('pbjs.requestBids not available; skipping Prebid auction in safe mode');
          if (typeof callback === 'function') callback();
          return;
        }

        pbjs.que.push(function() {
          try {
            pbjs.addAdUnits(adUnits);
            pbjs.requestBids({
              timeout: PREBID_TIMEOUT,
              bidsBackHandler: function() {
                try { if (typeof pbjs.setTargetingForGPTAsync === 'function') pbjs.setTargetingForGPTAsync(); } catch(e){}
                if (typeof callback === 'function') callback();
              }
            });
          } catch (e) {
            console.warn('Prebid request failed', e);
            if (typeof callback === 'function') callback();
          }

          // Ensure callback fires even if bidders hang
          setTimeout(function(){ try { if (typeof pbjs.setTargetingForGPTAsync === 'function') pbjs.setTargetingForGPTAsync(); } catch(e){}; if (typeof callback === 'function') callback(); }, PREBID_TIMEOUT + 300);
        });
      }

      window.requestPrebidSafe = requestPrebidSafe;
    })(window);
  </script>

  <!-- GPT setup (very defensive) -->
  <script>
    (function(){
      window.googletag = window.googletag || {cmd: []};

      // Prepare slot definition safely
      googletag.cmd.push(function(){
        try {
          if (typeof googletag.defineSlot !== 'function') {
            console.warn('googletag.defineSlot not available yet');
            return;
          }

          var mapping = null;
          if (typeof googletag.sizeMapping === 'function') {
            try {
              mapping = googletag.sizeMapping()
                .addSize([1024,0], [[970,250],[728,90]])
                .addSize([768,0], [[728,90]])
                .addSize([0,0], [[320,50]])
                .build();
            } catch(e) { mapping = null; }
          }

          var slot = googletag.defineSlot('/23322983346/456', [[970,250],[728,90],[320,50]], 'div-gpt-ad-123456789-0');
          if (slot && mapping && typeof slot.defineSizeMapping === 'function') slot.defineSizeMapping(mapping);
          if (slot && typeof slot.addService === 'function') slot.addService(googletag.pubads());

          // Configure pubads if available
          try {
            if (googletag.pubads) {
              var pub = googletag.pubads();
              if (pub) {
                if (typeof pub.enableSingleRequest === 'function') pub.enableSingleRequest();
                if (typeof pub.collapseEmptyDivs === 'function') pub.collapseEmptyDivs();
              }
            }
          } catch(e){ console.warn('pubads config failed', e); }
        } catch (err) {
          console.error('Error setting up slot', err);
        }
      });

      // Run Prebid safe flow, then enableServices and display
      window.requestPrebidSafe(function(){
        googletag.cmd.push(function(){
          try {
            // Apply targeting from Prebid if available
            try { if (window.pbjs && typeof pbjs.setTargetingForGPTAsync === 'function') pbjs.setTargetingForGPTAsync(); } catch(e){ console.warn('setTargetingForGPTAsync error', e); }

            // Enable lazy load if available
            try {
              var pub = googletag.pubads && googletag.pubads();
              if (pub && typeof pub.enableLazyLoad === 'function') pub.enableLazyLoad({fetchMarginPercent:200, renderMarginPercent:50, mobileScaling:2.0});
            } catch(e){ /* ignore */ }

            // Enable services only once
            try { if (typeof googletag.enableServices === 'function') googletag.enableServices(); } catch(e){ console.warn('enableServices failed', e); }

            // Finally display the slot
            try {
              if (typeof googletag.display === 'function') {
                googletag.display('div-gpt-ad-123456789-0');
              } else {
                console.warn('googletag.display not available');
              }
            } catch(e) {
              console.warn('display failed', e);
            }
          } catch(e) { console.error('Error in final GPT flow', e); }
        });
      });
    })();
  </script>

</body>
</html>